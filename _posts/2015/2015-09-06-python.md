---
layout: post
title:  "Python"
date:   2015-09-06 21:57:04
categories: jekyll update
---

![Dr Evil](/img/dr_evil.jpg =250x)
![Dr Evil](/img/dr_evil.jpg)

{% highlight python linenos%}
#!/usr/bin/env python
# -*- coding: utf-8 -*-
def up1_bdd():
    # Consultar la bdd y traer sÃ³lo los datos que tengan el adn vacio y luego armar una lista y grabar
    numeros = "1234567890" # Para buscar el codigo dentro del html
    caracteres = "1234567890." # Para buscar los caracteres dentro del 1000 up
    while True:
        try: 
            con = lite.connect('prom.db')
            conn = con.cursor() # Objeto cursor para hacer cambios en la Bdd
            conn.execute("SELECT nom FROM Prom WHERE adn is null ORDER BY random() LIMIT 10")
            i=conn.fetchone()
            conn.close()
            con.close()
            break
        except Exception as e:
            print("Error al traer la lista de nom desde la Bdd")
            if con:
                conn.close()
                con.close()
            time.sleep(0.5) # Esperar para volver a intentar acceder a la bdd
    # Para cada una de las consultas que tengan ADN vacio
    while i != None:
        # Inicializacion dentro del For
        opener = ""
        url = ""
        f= ""
        content = ""
        contents = "" #  cab_fasta y fasta
        op = "" # cod_sg_up
        cod = "" # cod_sg_bus8
        opener = urllib.request.FancyURLopener({})
        fasta=[]
        # PRIMERA ETAPA buscar el cod
        try:
            url = "http://solgenomics.net/search/quick?term="+i[0]+"&x=51&y=8"
            f = opener.open(url)
            # response = urllib.request.urlopen(url, timeout=10).read().decode('utf-8')
            # Expresiones regulares
            content = f.read()
            contents = content.decode(encoding='UTF-8')
            if contents.find("Genomic detail") >= 0:
                contents= contents.split('/details">')[0]
                contents= contents.split('Genomic detail')[1]
                if len(contents) != 0:
                    for ele in contents:
                        if ele in numeros:
                            cod+=ele
            else:
                cod = "NoGenDet";
        except Exception as problema:
            print ("1- Se ha producido un problema al acceder a la web:" + url)
            print (problema)
        # Segunda etapa 1000 upstream
        try:
            if cod != "NoGenDet":
                url = "http://solgenomics.net/feature/" + cod + "/details"
                f = opener.open(url)
                content = f.read()
                contents= content.decode(encoding='UTF-8')
                contents= contents.split(">1000 bp upstream</option>")[0]
                contents= contents.split("3000 bp upstream</option>")[1]
            else:
                contents= contents.split(">1000 bp upstream</option>")[0]
                contents= contents.split("3000 bp upstream</option>")[1]
        except Exception as problema:
            print ("2 - Se ha producido un problema al acceder a la web:" + url)
            print (problema)
        if len(contents) != 0:
            for ele in contents:
                if ele in caracteres:
                    op+=ele
                else:
                    if ele == ":":
                        op+="%3A"
        # Tercera etapa bajo el FASTA y doy forma
        try:
            url = "http://solgenomics.net/api/v1/sequence/download/multi?format=fasta&s=" + op
            f = opener.open(url)
            content = f.read()
            contents = content.decode(encoding='UTF-8')
            fasta = contents.split('\n',1)
        except Exception as problema:
            print ("3 - Se ha producido un problema al acceder a la web:" + url)
            print (problema)
        # Grabar en la Bdd
        if cod != '' and op !='' and len(fasta)!=0:
            while True:
                try:
                    con = lite.connect('prom.db')
                    conn = con.cursor() # Objeto cursor para hacer cambios en la Bdd
                    conn.execute("UPDATE Prom SET cab_adn=?,adn=?,cod_sg_bus=?,cod_sg_up=? WHERE nom = ? ",(fasta[0],fasta[1],cod,op,i[0])) # Guardo los datos extraids en la bdd
                    con.commit()
                    conn.execute("SELECT nom FROM Prom WHERE adn is null ORDER BY random() LIMIT 30")
                    i=conn.fetchone()
                    conn.close()
                    con.close()
                    break
                except Exception as e:
                    print ("%s %s" % (e.args[0],threading.currentThread().getName()))
                    if con:
                        conn.close()
                        con.close()
                    # time.sleep(1)
        else:
            print("Cod, o op o fasta estan vacios")
{% endhighlight %}